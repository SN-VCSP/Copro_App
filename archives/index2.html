<!DOCTYPE html>
<html lang="fr">
<head>
  <!-- =========================================================
       Poubelles Copro ‚Äî Version B : Pop-up conditionnel am√©lior√©
       - Pop-up affich√© les jours de t√¢che
       - SINON : pop-up d'information "aucune t√¢che" (donc visible quand m√™me)
       - Option "Ne plus afficher aujourd'hui"
       - Verrou quotidien (localStorage)
       ========================================================= -->
  <meta charset="utf-8" />
  <title>Poubelles Copro ‚Äî Version B (Pop-up conditionnel am√©lior√©)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <style>
    :root{
      --bg1:#3ea76a; --bg2:#a7f3d0;
      --card:#0b1225; --text:#f8fafc; --muted:#cbd5e1;
      --ring:#334155; --accent:#facc15;
      --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --sofienn:#22c55e; --vanessa:#3b82f6; --anthony:#f59e0b; --marc:#8b5cf6; --libre:#64748b;
      --radius:14px;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --shadow-soft: 0 6px 18px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      color:var(--text)
    }
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(90deg,#22c55e,#84cc16);
      padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.2);
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap
    }
    .brand{display:flex;align-items:center;gap:10px;flex:1}
    .logo{width:32px;height:32px;border-radius:10px;background:conic-gradient(#22c55e,#f59e0b,#06b6d4,#84cc16)}
    .brand h1{margin:0;font-size:16px}
    nav{display:flex;gap:8px;margin-top:6px}
    nav button{
      flex:1;padding:8px;border:1px solid rgba(255,255,255,.2);
      border-radius:10px;background:rgba(0,0,0,.25);color:var(--text);
      font-weight:600;font-size:14px;transition:all .2s;cursor:pointer;
      box-shadow: var(--shadow-soft);
    }
    nav button.active{border-color:#fff;box-shadow:0 0 10px rgba(255,255,255,.5) inset}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{
      padding:8px 10px;border:1px solid rgba(255,255,255,.2);
      border-radius:10px;background:#0b1225;color:var(--text);cursor:pointer;font-weight:600;
      box-shadow: var(--shadow-soft);
    }
    .btn.secondary{background:#0f172a}
    .btn.success{background:#14532d}
    .btn.warn{background:#7c2d12}
    main{padding:12px}
    .card{
      background:rgba(11,18,37,.85);
      backdrop-filter:blur(6px);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      padding:14px;margin-bottom:14px;
      box-shadow: var(--shadow);
    }

    .hero-center{text-align:center;padding:20px}
    .hero-center h2{margin:6px 0;font-size:20px}
    .hero-center .date{font-size:14px;color:#d1d5db;margin-bottom:8px}
    .hero-center .week{font-size:16px;color:var(--accent);margin-bottom:12px}
    .hero-center .resp{font-size:24px;font-weight:700;margin-bottom:8px}
    .hero-center .resp .tag{padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.2);margin-left:6px;font-size:.9rem}
    .hero-center .nextTask, .hero-center .nextWeek{font-size:14px;color:#d1d5db;margin-top:6px}
    .countdown{margin-top:10px;font-weight:700;font-size:18px}
    .progress-wrap{margin-top:10px;background:#0f172a;border-radius:999px;height:10px;overflow:hidden;border:1px solid var(--ring)}
    .progress{height:100%;width:0%}

    .month-bar{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;flex-wrap:wrap}
    .month-nav{display:flex;align-items:center;justify-content:center;gap:10px;font-weight:700;font-size:16px;flex-wrap:wrap}
    .month-nav button{background:#0f172a;border:none;color:#fff;cursor:pointer;border-radius:8px;padding:4px 8px;font-size:15px;box-shadow: var(--shadow-soft)}
    .week{background:#1e293b;border:1px solid var(--ring);border-radius:10px;padding:10px;margin-bottom:8px}
    .week h3{margin:0 0 6px 0;font-size:14px;color:var(--accent);display:flex;align-items:center;gap:8px;justify-content:space-between}
    .week .range{color:#cbd5e1;font-weight:500}
    .tag{padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.2)}
    .week.libre{background:#374151}
    .task{margin:4px 0;padding:6px 8px;border-radius:6px;background:#0b1225;font-size:13px;display:flex;align-items:center;justify-content:space-between;border:1px solid transparent}
    .task .left{display:flex;align-items:center;gap:8px}
    .task .when{color:#cbd5e1;font-size:12px}
    .task.today{border-color:var(--accent);box-shadow:0 0 0 1px rgba(250,204,21,.4)}
    .task .badge{padding:2px 6px;border-radius:6px;border:1px solid rgba(255,255,255,.15);font-size:12px}

    .legend{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .legend .pill{display:flex;gap:6px;align-items:center;background:#0b1225;border:1px solid var(--ring);border-radius:999px;padding:4px 8px;font-size:12px}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:60}
    .modal.open{display:flex}
    .modal .box{background:#0b1225;border:1px solid var(--ring);border-radius:14px;max-width:680px;width:90%;padding:16px;text-align:left}
    .modal .box h3{margin:0 0 8px 0}
    .modal .box p{margin:.25rem 0;color:#e5e7eb}
    .modal .box footer{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px}
    .modal .box .close{margin-top:12px;cursor:pointer;border:none;background:#0f172a;color:#fff;border-radius:8px;padding:10px 14px;font-weight:700}

    .footer{padding:10px;color:#e2e8f0;font-size:11px;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>üöÆ Poubelles Copro</h1>
    </div>
    <nav role="tablist">
      <button id="tab-home" class="active" role="tab" aria-selected="true" aria-controls="home">Accueil</button>
      <button id="tab-planning" role="tab" aria-selected="false" aria-controls="planning">Planning</button>
    </nav>
    <div class="actions">
      <button id="notifyToggle" class="btn secondary" type="button">üîî Activer rappels</button>
      <button id="openRules" class="btn" type="button" aria-haspopup="dialog" aria-controls="rulesModal">‚ÑπÔ∏è R√®gles</button>
      <button id="forceDailyPopup" class="btn warn" type="button" title="Forcer le pop-up (test)">‚öôÔ∏è Tester pop-up</button>
    </div>
  </header>

  <main>
    <!-- Accueil -->
    <section id="home" class="tabs active" role="tabpanel" aria-labelledby="tab-home">
      <div class="card hero-center">
        <div class="date" id="todayText">‚Äî</div>
        <div class="week" id="weekInfo">‚Äî</div>
        <div class="resp" id="heroWho">Responsable: ‚Äî</div>

        <div class="countdown" id="countdown">‚Äî</div>
        <div class="progress-wrap" aria-label="Progression de la semaine">
          <div id="weekProgress" class="progress"></div>
        </div>

        <div class="nextTask" id="heroTask">Prochaine t√¢che: ‚Äî</div>
        <div class="nextWeek" id="nextResp">Prochaine semaine: ‚Äî</div>
      </div>
    </section>

    <!-- Planning -->
    <section id="planning" class="tabs" role="tabpanel" aria-labelledby="tab-planning" hidden>
      <div class="card">
        <div class="month-bar">
          <div class="month-nav">
            <button id="prevMonth" type="button">‚óÄÔ∏è</button>
            <span id="monthLabel">‚Äî</span>
            <button id="nextMonth" type="button">‚ñ∂Ô∏è</button>
          </div>
          <div class="actions">
            <button id="exportWeek" class="btn success" type="button">üìÖ Exporter semaine</button>
            <button id="exportMonth" class="btn success" type="button">üìÖ Exporter mois</button>
          </div>
        </div>
        <div id="legend" class="legend"></div>
        <div id="weeksContainer"></div>
      </div>
    </section>
  </main>

  <div class="footer">R√®gle: 1er lundi ‚Üí Sofienn, puis Vanessa, Anthony, Marc. 5e semaine = LIBRE.</div>

  <!-- PopUp (conditionnel + info si rien) -->
  <div id="dailyPopup" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="popupTitle" aria-describedby="popupMessage">
    <div class="box">
      <h3 id="popupTitle">Rappel</h3>
      <p id="popupMessage">Message</p>
      <div id="popupExtra" style="font-size:13px;color:#cbd5e1"></div>
      <footer>
        <button id="dismissToday" class="btn secondary" type="button">üôà Ne plus afficher aujourd‚Äôhui</button>
        <button class="close" id="closePopup" type="button">OK</button>
      </footer>
    </div>
  </div>

  <!-- Modal R√®gles -->
  <div id="rulesModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="rulesTitle">
    <div class="box">
      <button class="close" id="closeRules" type="button">Fermer</button>
      <h3 id="rulesTitle">R√®gles de la copro ‚Äî gestion des poubelles</h3>
      <ul>
        <li>Le responsable de la semaine est d√©fini par l‚Äôordre : <b>Sofienn ‚Üí Vanessa ‚Üí Anthony ‚Üí Marc</b>, √† partir du <b>1er lundi</b> du mois.</li>
        <li>La <b>5e semaine</b> (si elle existe) est <b>LIBRE</b> : chacun reste vigilant.</li>
        <li>T√¢ches : <b>Sortie</b> mardi & vendredi 18h, <b>Rentr√©e</b> mercredi & samedi 8h.</li>
        <li>En cas d‚Äôemp√™chement, essayez d‚Äô√©changer en direct (sans passer par l‚Äôappli).</li>
      </ul>
      <p style="color:#cbd5e1;font-size:14px">Un cadenas sera ajout√© en cas de manquement √† vos obligations</p>
    </div>
  </div>

<script>
/* === Donn√©es === */
const PEOPLE=["Sofienn","Vanessa","Anthony","Marc"];
const PERSON_COLORS={
  "Sofienn":"var(--sofienn)",
  "Vanessa":"var(--vanessa)",
  "Anthony":"var(--anthony)",
  "Marc":"var(--marc)",
  "LIBRE":"var(--libre)"
};
const TASKS=[
  {icon:"üóëÔ∏è",label:"Sortie",whenLabel:"Mardi soir",dow:2,time:"18:00"},
  {icon:"üè†",label:"Rentr√©e",whenLabel:"Mercredi matin",dow:3,time:"08:00"},
  {icon:"üóëÔ∏è",label:"Sortie",whenLabel:"Vendredi soir",dow:5,time:"18:00"},
  {icon:"üè†",label:"Rentr√©e",whenLabel:"Samedi matin",dow:6,time:"08:00"},
];

const LS_SEEN_DATE = "pc_popup_seen_date_vB";

function pad(n){return n<10?"0"+n:n;}
function fmtDate(d){return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;}
function fmtTime(d){return `${pad(d.getHours())}:${pad(d.getMinutes())}`;}
function startOfDay(d){const x=new Date(d);x.setHours(0,0,0,0);return x;}
function addDays(d,n){const x=new Date(d);x.setDate(x.getDate()+n);return x;}
function setTime(d,hhmm){const x=new Date(d);const [hh,mm]=hhmm.split(":").map(Number);x.setHours(hh||0,mm||0,0,0);return x;}
function firstMondayOfMonth(y,m){const d=new Date(y,m,1);const day=d.getDay();const off=(day===0)?1:(day===1?0:(8-day)%7);d.setDate(d.getDate()+off);return startOfDay(d);}
function weekRange(ws){const we=addDays(ws,6);return `${fmtDate(ws)} ‚Üí ${fmtDate(we)}`;}
function isSameDay(a,b){return a.getFullYear()===b.getFullYear()&&a.getMonth()===b.getMonth()&&a.getDate()===b.getDate();}
function iso(d){return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`}

/* Planning */
let PLAN=[], FUTURE_MONTHS=[], currentMonthIndex=0;
function buildMonth(year,monthIdx){
  const firstMon=firstMondayOfMonth(year,monthIdx);
  const weeks=[];
  for(let w=0;w<5;w++){
    const ws=addDays(firstMon,7*w);
    if(ws.getMonth()!==monthIdx && w>0) break;
    let responsible=null;
    if(w<4) responsible=PEOPLE[w];
    const tasks=TASKS.map(t=>{
      const delta=(t.dow+6)%7;
      const dd=addDays(ws,delta);
      return {date:setTime(dd,t.time),icon:t.icon,label:t.label,whenLabel:t.whenLabel,who:responsible||"LIBRE"};
    });
    weeks.push({weekStart:ws,responsible:responsible||"LIBRE",isLibre:!responsible,tasks});
  }
  return {year,monthIdx,weeks};
}
function generateYearPlan(){
  const now=new Date();const y0=now.getFullYear();const m0=now.getMonth();const plan=[];
  for(let i=0;i<12;i++){
    const y=(m0+i>=12)?y0+1:y0;const m=(m0+i)%12;
    plan.push(buildMonth(y,m));
  }
  PLAN=plan;
  FUTURE_MONTHS=PLAN.filter(m=>{
    const nm=new Date();
    return (m.year>nm.getFullYear())||(m.year===nm.getFullYear()&&m.monthIdx>=nm.getMonth());
  });
}

/* Trouver semaine et t√¢ches */
function findCurrentWeek(){
  const now=new Date();let hit=null;
  PLAN.forEach(m=>m.weeks.forEach((w,i)=>{
    const end=addDays(w.weekStart,7);
    if(now>=w.weekStart&&now<end) hit={...w,index:i+1};
  }));
  return hit;
}
function findNextTask(){
  const now=new Date();let nearest=null;
  PLAN.forEach(m=>m.weeks.forEach(w=>w.tasks.forEach(t=>{
    if(t.date>now){if(!nearest||t.date<nearest.date) nearest=t;}
  })));
  return nearest;
}

/* UI */
function setActiveTab(tab){
  document.querySelectorAll("nav button").forEach(b=>b.classList.remove("active"));
  document.querySelectorAll(".tabs").forEach(s=>{
    s.classList.remove("active");
    s.hidden = true;
  });
  document.getElementById(`tab-${tab}`).classList.add("active");
  const el=document.getElementById(tab);
  el.classList.add("active");
  el.hidden = false;
  document.getElementById("tab-home").setAttribute("aria-selected", tab==="home" ? "true" : "false");
  document.getElementById("tab-planning").setAttribute("aria-selected", tab==="planning" ? "true" : "false");
}
function colorFor(person){
  return PERSON_COLORS[person]||"var(--libre)";
}

function renderHome(){
  const now=new Date();
  document.getElementById("todayText").textContent=`Aujourd'hui : ${fmtDate(now)} (${["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"][now.getDay()]})`;
  const cw=findCurrentWeek();
  if(cw){
    document.getElementById("weekInfo").textContent=`Semaine ${cw.index}`;
    const tag=`<span class="tag" style="border-color:${colorFor(cw.responsible)};color:${colorFor(cw.responsible)}">${cw.responsible}</span>`;
    document.getElementById("heroWho").innerHTML=`Responsable: ${tag}`;
  } else {
    document.getElementById("weekInfo").textContent=`Semaine ‚Äî`;
    document.getElementById("heroWho").textContent=`Responsable: ‚Äî`;
  }
  const nt=findNextTask();
  if(nt){
    document.getElementById("heroTask").textContent=`Prochaine t√¢che: ${nt.icon} ${nt.label} ‚Äî ${nt.whenLabel} (${fmtDate(new Date(nt.date))} ${fmtTime(new Date(nt.date))}) ‚Ä¢ ${nt.who}`;
  } else {
    document.getElementById("heroTask").textContent=`Prochaine t√¢che: ‚Äî`;
  }
  // progression
  const monday=addDays(startOfDay(now), (1 - (now.getDay()||7)));
  const total=7*24*60*60*1000, elapsed=now - monday;
  const ratio=Math.max(0, Math.min(1, elapsed/total));
  const bar=document.getElementById("weekProgress");
  bar.style.width = (ratio*100).toFixed(1)+"%";
  bar.style.background = `linear-gradient(90deg, var(--ok), var(--warn), var(--danger))`;
}
let countdownTimer=null;
function updateCountdown(target){
  clearInterval(countdownTimer);
  function tick(){
    const now=new Date();
    const diff=target-now;
    if(diff<=0){
      document.getElementById("countdown").textContent="C'est maintenant !";
      clearInterval(countdownTimer);
      return;
    }
    const h=Math.floor(diff/3.6e6);
    const m=Math.floor((diff%3.6e6)/6e4);
    const s=Math.floor((diff%6e4)/1e3);
    document.getElementById("countdown").textContent=`‚è≥ Prochaine t√¢che dans ${h}h ${m}m ${s}s`;
  }
  tick();
  countdownTimer=setInterval(tick,1000);
}

/* Rendu PLANNING */
function renderLegend(){
  const el=document.getElementById("legend");
  el.innerHTML="";
  ["Sofienn","Vanessa","Anthony","Marc","LIBRE"].forEach(p=>{
    const pill=document.createElement("div");
    pill.className="pill";
    pill.innerHTML=`<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${colorFor(p)}"></span>${p}`;
    el.appendChild(pill);
  });
}
function renderWeeks(){
  const cont=document.getElementById("weeksContainer");
  cont.innerHTML="";
  const today=new Date();
  let allWeeks = [];
  FUTURE_MONTHS.forEach(m => allWeeks.push(...m.weeks));
  allWeeks = allWeeks.filter(w => addDays(w.weekStart,7) >= today);
  const next6 = allWeeks.slice(0,6);
  document.getElementById("monthLabel").textContent = `Prochaines semaines (${next6.length})`;
  next6.forEach((w,i)=>{
    const wrap=document.createElement("div");
    wrap.className="week"+(w.isLibre?" libre":"");
    const range=weekRange(w.weekStart);
    const tagColor=colorFor(w.responsible);
    wrap.innerHTML=`<h3>
      <span>Semaine ${i+1} ‚Äî <span class="tag" style="border-color:${tagColor};color:${tagColor}">${w.responsible}</span></span>
      <span class="range">${range}</span>
    </h3>`;
    w.tasks.forEach(t=>{
      const d=new Date(t.date);
      const dd=fmtDate(d);
      const row=document.createElement("div");
      row.className="task";
      if(isSameDay(d,today)) row.classList.add("today");
      row.innerHTML=`
        <div class="left">
          <span>${t.icon}</span>
          <div>
            <div><b>${t.label}</b> ‚Äî ${t.whenLabel}</div>
            <div class="when">${dd} ‚Ä¢ ${fmtTime(d)}</div>
          </div>
        </div>
        <div class="badge" style="border-color:${tagColor};color:${tagColor}">${t.who}</div>
      `;
      wrap.appendChild(row);
    });
    cont.appendChild(wrap);
  });
}

/* Export ICS */
function toICSDate(dt){
  const y=dt.getFullYear();
  const mo=pad(dt.getMonth()+1);
  const da=pad(dt.getDate());
  const h=pad(dt.getHours());
  const mi=pad(dt.getMinutes());
  const s=pad(dt.getSeconds());
  return `${y}${mo}${da}T${h}${mi}${s}`;
}
function generateICS(events, filename="poubelles.ics"){
  const lines=[
    "BEGIN:VCALENDAR",
    "VERSION:2.0",
    "PRODID:-//Poubelles Copro//FR",
  ];
  events.forEach(ev=>{
    const uid=`${ev.start.getTime()}-${Math.random().toString(36).slice(2)}@poubelles-copro`;
    const dtstart=toICSDate(ev.start);
    const dtend=toICSDate(ev.end);
    const summary=ev.summary.replace(/([,;])/g,"\\$1");
    const desc=(ev.description||"").replace(/([,;])/g,"\\$1");
    lines.push(
      "BEGIN:VEVENT",
      `UID:${uid}`,
      `DTSTAMP:${toICSDate(new Date())}`,
      `DTSTART:${dtstart}`,
      `DTEND:${dtend}`,
      `SUMMARY:${summary}`,
      `DESCRIPTION:${desc}`,
      "END:VEVENT"
    );
  });
  lines.push("END:VCALENDAR");
  const blob=new Blob([lines.join("\r\n")],{type:"text/calendar"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  URL.revokeObjectURL(a.href);
  a.remove();
}
function collectWeekEvents(week){
  return week.tasks.map(t=>{
    const start=new Date(t.date);
    const end=new Date(start.getTime()+30*60000);
    return {start,end,summary:`${t.icon} ${t.label} ‚Äî ${t.who}`,description:t.whenLabel};
  });
}
function collectMonthEvents(month){
  const ev=[]; month.weeks.forEach(w=>ev.push(...collectWeekEvents(w))); return ev;
}

/* R√®gles modal */
function openRules(){const m=document.getElementById("rulesModal");m.classList.add("open");m.setAttribute("aria-hidden","false");}
function closeRules(){const m=document.getElementById("rulesModal");m.classList.remove("open");m.setAttribute("aria-hidden","true");}

/* === Pop-up conditionnel + info si rien === */
function popupSeenToday(){
  try{ return localStorage.getItem(LS_SEEN_DATE)===iso(new Date()); }catch(_){ return false; }
}
function markSeenToday(){
  try{ localStorage.setItem(LS_SEEN_DATE, iso(new Date())); }catch(_){}
}
function openPopup(title, message, extraHtml=""){
  const modal=document.getElementById("dailyPopup");
  document.getElementById("popupTitle").textContent=title||"Rappel";
  document.getElementById("popupMessage").textContent=message||"";
  document.getElementById("popupExtra").innerHTML=extraHtml||"";
  modal.classList.add("open");
  modal.setAttribute("aria-hidden","false");
}
function closePopup(){
  const modal=document.getElementById("dailyPopup");
  modal.classList.remove("open");
  modal.setAttribute("aria-hidden","true");
}

/**
 * checkDailyPopupEnhanced()
 * - Si jour de t√¢che : pop-up "action"
 * - Sinon : pop-up "info" pour √©viter la sensation de bug
 * - Verrou quotidien (configurable via bouton "Tester pop-up")
 */
function checkDailyPopupEnhanced(force=false){
  if(!force && popupSeenToday()) return;

  const today=new Date();
  const cw=findCurrentWeek();
  let title="Information du jour";
  let message="Aucune t√¢che pr√©vue aujourd‚Äôhui.";
  let extra="";

  let taskToday=null;
  if(cw){ taskToday=cw.tasks.find(t=>isSameDay(t.date,today)); }

  if(taskToday){
    title = "C'est aujourd‚Äôhui !";
    if(cw.responsible==="LIBRE"){
      message=`üö® ${taskToday.label} (${taskToday.whenLabel}) ‚Äî Pas de responsable d√©sign√©. Quelqu‚Äôun s‚Äôen charge ?`;
    } else {
      message=`${taskToday.icon} ${cw.responsible}, c'est ton tour ! (${taskToday.label} ‚Äî ${taskToday.whenLabel}) üí™`;
    }
  }

  const nt=findNextTask();
  if(nt){
    const nd=new Date(nt.date);
    extra = `
      <div>
        <strong>Prochaine t√¢che :</strong> ${nt.icon} ${nt.label} ‚Äî ${nt.whenLabel}
        <br>${fmtDate(nd)} ‚Ä¢ ${fmtTime(nd)} ‚Ä¢ <span style="color:${colorFor(nt.who)}">${nt.who}</span>
      </div>`;
  }

  openPopup(title, message, extra);
  markSeenToday();
}

/* Init */
function init(){
  generateYearPlan();
  renderHome(); renderLegend(); renderWeeks();

  document.getElementById("tab-home").addEventListener("click",()=>setActiveTab("home"));
  document.getElementById("tab-planning").addEventListener("click",()=>setActiveTab("planning"));
  document.getElementById("prevMonth").addEventListener("click",()=>{if(currentMonthIndex>0){currentMonthIndex--;renderWeeks();}});
  document.getElementById("nextMonth").addEventListener("click",()=>{if(currentMonthIndex<FUTURE_MONTHS.length-1){currentMonthIndex++;renderWeeks();}});

  document.getElementById("exportWeek").addEventListener("click",()=>{
    const cw=findCurrentWeek();
    if(!cw) return alert("Semaine courante introuvable.");
    generateICS(collectWeekEvents(cw), `poubelles-semaine-${fmtDate(cw.weekStart).replaceAll('/','')}.ics`);
  });
  document.getElementById("exportMonth").addEventListener("click",()=>{
    const m=FUTURE_MONTHS[currentMonthIndex] || FUTURE_MONTHS[0];
    if(!m) return alert("Aucun mois √† exporter.");
    generateICS(collectMonthEvents(m), `poubelles-${(m.monthIdx+1).toString().padStart(2,'0')}-${m.year}.ics`);
  });

  // r√®gles
  document.getElementById("openRules").addEventListener("click",openRules);
  document.getElementById("closeRules").addEventListener("click",closeRules);

  // popups
  document.getElementById("closePopup").addEventListener("click", closePopup);
  document.getElementById("dismissToday").addEventListener("click", ()=>{
    markSeenToday();
    closePopup();
  });

  // bouton de test (ignore le verrou)
  document.getElementById("forceDailyPopup").addEventListener("click", ()=> checkDailyPopupEnhanced(true));

  // rafra√Æchit la home
  setInterval(()=>{ renderHome(); }, 60_000);

  // ‚úÖ affichage conditionnel am√©lior√© au d√©marrage
  requestAnimationFrame(()=> checkDailyPopupEnhanced(false));
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
